<!DOCTYPE html>
<html>
<head>
    <title>Ludovision</title>
    <style>
        body {
            background-color: black;
            color: white;
            font-family: sans-serif;
            margin: 0;
        }

        h1 {
            font-size: 1.5em;
            margin: 0;
            padding: 15px;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #header {
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            display: none;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }

        #debug-info {
            margin-right: 30px;
        }

        #images-container {
            display: none;
            /* grid-template-columns: repeat(auto-fill, minmax(128px, 1fr)); */
            gap: 10px;
            overflow: auto;
            max-height: 100vh;
            padding: 0px 10px 0px 10px;
        }

        .image-container {
            position: relative;
            overflow: hidden;
            height: 100%;
        }

        .image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
        }

        #image-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 110;
            backdrop-filter: blur(10px);
            display: none;
        }

        #modal-image {
            max-width: 90%;
            max-height: 90%;
            border-radius: 20px;
        }

        #modal-nav {
            display: flex;
            gap: 10px;
        }

        #warning-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.75);
            z-index: 1000;
        }

        #warning-modal h1 {
            font-size: 2rem;
            padding: 10px 0px;
            margin: 0px;
            font-weight: bold;
            color: red;
        }

        #warning-text {
            width: 450px;
            margin-top: 20px;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 30px;
        }

        #ok-button {
            background-color: #38a169; /* Green */
        }

        #ok-button:hover {
            background-color: #2f855a;
        }

        #cancel-button {
            background-color: #e53e3e; /* Red */
        }

        #cancel-button:hover {
            background-color: #c53030;
        }

        .view-all-media-button {
            display: none;
            background-color: #333; /* Dark gray */
        }

        .view-all-media-button:hover {
            background-color: #222;
        }

        #gallery-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.75);
            z-index: 105;
            backdrop-filter: blur(10px);
        }

        #gallery-modal .grid {

            display: grid;
            grid-auto-rows: auto;
            grid-template-columns: repeat(auto-fit, minmax(128px, max-content));
            justify-content: center; /* Center the grid horizontally */
            gap: 10px; /* Add spacing between grid items */
            max-width: 80%; /* Restrict the grid to 90% of its container */
            margin: 0 auto; /* Center the grid in its container */
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.8);
            overflow: auto;
            max-height: 90%;

        }

        #close-gallery-button {
            background-color: #f56565; /* Red */
        }

        .view-profile-button {
            background-color: #38a169; /* Green */
        }

        .view-profile-button:hover {
            background-color: #2f855a;
        }

        #close-gallery-button:hover {
            background-color: #e53e3e;
        }

        #gallery-modal .grid img {
            width: 128px;
            height: 128px;
            object-fit: cover;
            overflow: hidden;
            cursor: pointer;
        }

        #gallery-image-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 120;
            backdrop-filter: blur(10px);
            display: none;
        }

        #gallery-modal-image {
            max-width: 90%;
            max-height: 90%;
            border-radius: 20px;
            margin-bottom: 20px;
            cursor: pointer;
        }

        #magnifier {
            position: absolute;
            width: 512px;
            height: 512px;
            border: 2px solid #fff;
            border-radius: 50%; /* Circular magnifier */
            overflow: hidden;
            background-repeat: no-repeat;
            background-size: auto;
            cursor: none; /* Hide default cursor inside magnifier */
            pointer-events: none; /* Make it non-interactive */
            z-index: 1000; /* Above other content */
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        #image-size-slider {
            width: 200px;
        }

        label {
            font-size: 1em;
            color: white;
        }

    </style>
</head>
<body>

    
    <div id="warning-modal">
        <div>
            <h1>WARNING</h1>
            <p id="warning-text" style="text-transform: uppercase;">
                You are viewing raw image data directly from the Bluesky firehose. This data INCLUDES unfiltered, unmoderated, and potentially sensitive content. Viewer discretion is advised. Proceed only if you are prepared to encounter images that have not been reviewed for appropriateness or relevance.
            </p>
            <p id="warning-text">
                <strong></strong>Disclaimer:</strong><br>
                The creator of this tool assumes no responsibility for the content accessed through this service. Any inappropriate use, redistribution, or exploitation of the data is strictly prohibited. By continuing, you agree to hold the creator harmless from any liability arising from your use of this data.
            </p>
            <div class="modal-buttons">
                <button id="ok-button">OK</button>
                <button id="cancel-button">Cancel</button>
            </div>
        </div>
    </div>

    <div id="header">
        <h1>Ludovision: Images from the Bluesky firehose</h1>
        <div class="slider-container">
            <label for="image-size-slider">Image Size: <span id="slider-value">128</span>px</label>
            <input type="range" id="image-size-slider" min="32" max="512" value="128" step="1">
        </div>
        <div id="debug-info"></div>
    </div>

    <div id="images-container">
        <!-- Images will be appended here -->
    </div>

    <div id="image-modal">
        <img id="modal-image" alt="Full-size image" style="max-width: 90%; max-height: 90%;">
        <div class="modal-buttons">
            <button id="profile-link" class="view-profile-button" href="#" target="_blank">View Profile</button>
            <button id="view-all-media-button" class="view-all-media-button" href="#">View Gallery</button>
        </div>
    </div>

    <div id="gallery-modal">
        <div class="grid">
            <!-- Gallery images will be appended here -->
        </div>
        <div class="modal-buttons">
            <button id="close-gallery-button">Close</button>
            <button id="gallery-profile-link" class="view-profile-button" href="#" target="_blank">View Profile</button>
        </div>
    </div>

    <div id="gallery-image-modal" style="display: none;">
        <img id="gallery-modal-image" alt="Full-size gallery image" style="max-width: 90%; max-height: 90%;">
        <div id="magnifier" style="display: none;"></div>
    </div>

    <!-- Include settings script -->
    <script src="settings.js"></script>

    <script>

    document.addEventListener('DOMContentLoaded', function () {

        // Settings
        const settings = typeof window.settings === 'object' ? window.settings : {};
        let token = null;
        let refreshToken = null;
        let imageSize = typeof settings.imageSize === 'number' ? settings.imageSize : 128;
        let launchWarning = typeof settings.launchWarning === 'boolean' ? settings.launchWarning : true;
        let magnifier = typeof settings.magnifier === 'boolean' ? settings.magnifier : true;

        // Bluesky credentials
        let bsky_identifier = typeof settings.bsky_identifier === 'string' ? settings.bsky_identifier : null;
        let bsky_appPassword = typeof settings.bsky_appPassword === 'string' ? settings.bsky_appPassword : null;

        // Elements
        const header = document.getElementById('header');
        const warningModal = document.getElementById('warning-modal');
        const okButton = document.getElementById('ok-button');
        const cancelButton = document.getElementById('cancel-button');
        const galleryModal = document.getElementById('gallery-modal');
        const closeGalleryButton = document.getElementById('close-gallery-button');
        const imagesContainer = document.getElementById('images-container');
        const modal = document.getElementById('image-modal');
        const modalImage = document.getElementById('modal-image');
        const profileLink = document.getElementById('profile-link');
        const galleryProfileLink = document.getElementById('gallery-profile-link');
        const viewAllMediaButton = document.getElementById('view-all-media-button');
        const galleryContainer = document.querySelector('#gallery-modal .grid');
        const galleryImageModal = document.getElementById('gallery-image-modal');
        const galleryImages = Array.from(document.querySelectorAll('#gallery-modal .grid img'));
        const imageSizeSlider = document.getElementById('image-size-slider');
        const sliderValueDisplay = document.getElementById('slider-value');

        // warning modal
        if(launchWarning) {
            warningModal.style.display = 'flex';
        } else {
            header.style.display = 'flex';
            setupWebSocket(); // Call WebSocket setup
        }

        // Variables
        let totalImages = 0;
        let currentGalleryImageIndex = 0;

        // Set grid-template-columns
        imagesContainer.style.gridAutoRows = `${imageSize}px`; // Set the height
        imagesContainer.style.gridTemplateColumns = `repeat(auto-fill, minmax(${imageSize}px, 1fr))`;

        
        // Warning modal handlers
        okButton.addEventListener('click', function () {
            warningModal.style.display = 'none';
            header.style.display = 'flex';
            setupWebSocket(); // Call WebSocket setup
        });

        cancelButton.addEventListener('click', function () {
            window.location.href = 'https://bsky.app'; // Redirect
        });

        // Close gallery modal
        closeGalleryButton.addEventListener('click', function () {
            galleryModal.style.display = 'none';
        });

        // Open profile in new tab
        document.addEventListener('click', function (event) {
            if(event.target === profileLink || event.target === galleryProfileLink) {
                event.preventDefault();
                window.open(event.target.href, '_blank');
            }
        });

        // Open gallery modal
        viewAllMediaButton.addEventListener('click', function () {
            modal.style.display = 'none'; // Close image modal
            fetchGalleryImages(profileLink.href); // Fetch images
            galleryModal.style.display = 'flex'; // Open gallery modal
        });

        // WebSocket setup
        function setupWebSocket() {

            const socket = new WebSocket('wss://jetstream1.us-east.bsky.network/subscribe?wantedCollections=app.bsky.feed.post');

            socket.addEventListener('message', function (event) {
                try {

                    imagesContainer.style.display = 'grid';
                    const decodedMessage = JSON.parse(event.data);
                    if (
                        decodedMessage.commit &&
                        decodedMessage.commit.record &&
                        decodedMessage.commit.record.embed &&
                        decodedMessage.commit.record.embed.images
                    ) {

                        // Get images and profile DID
                        const images = decodedMessage.commit.record.embed.images;
                        const profileDid = decodedMessage.did;

                        // Set profile link
                        const profileLinkUrl = `https://bsky.app/profile/${decodedMessage.did}`;

                        // Append images
                        images.forEach(image => {
                            const link = image.image.ref['$link'];
                            const mimeType = image.image.mimeType.split('/')[1];
                            const imageUrl = `https://cdn.bsky.app/img/feed_thumbnail/plain/${decodedMessage.did}/${link}@${mimeType}`;
                            appendImage(imageUrl, profileLinkUrl, profileDid);
                        });

                    }
                } catch (error) {
                    console.error('Error parsing WebSocket message:', error);
                }
            });

            socket.addEventListener('open', function () {
                console.log('WebSocket connection established');
            });

            socket.addEventListener('close', function () {
                console.log('WebSocket connection closed');
            });
        }

        // Create IntersectionObserver for lazy loading
        const observer = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    if (img.dataset.src) {
                        img.src = img.dataset.src; // Set the real image source
                        img.style.opacity = 1; // Make the image visible
                        observer.unobserve(img); // Stop observing the image
                    }
                }
            });
        }, {
            root: null, // Default to the viewport
            rootMargin: "0px", // Load the image when it enters the viewport
            threshold: 0.1 // Trigger when 10% of the image is visible
        });

        // Append image and apply lazy loading
        function appendImage(imageUrl, profileLinkUrl, profileDid) {
            const imageDiv = document.createElement('div');
            imageDiv.className = 'image-container';

            const imgElement = document.createElement('img');
            imgElement.dataset.src = imageUrl;
            imgElement.alt = 'No description available';

            imgElement.addEventListener('click', () => {
                openImageModal(imageUrl, profileLinkUrl, profileDid);
            });

            imageDiv.appendChild(imgElement);
            imagesContainer.appendChild(imageDiv);

            // Observe only the newly created image
            observer.observe(imgElement);

            totalImages++;
            updateDebugInfo();
        }

        // Observe all images for lazy loading
        document.querySelectorAll('.image-container img').forEach(img => observer.observe(img));

        // Open image modal
        function openImageModal(imageUrl, profileLinkUrl, profileDid) {
            modalImage.src = imageUrl;
            profileLink.href = profileLinkUrl;
            profileLink.textContent = 'View Profile';
            modal.style.display = 'flex'; // Show modal
        }

        // Fetch profile gallery images
        function fetchGalleryImages(profileUrl) {

            // Clear previous content
            galleryContainer.innerHTML = ''; 

            // Extract DID from profile URL
            const profileDid = profileUrl.split('/').pop();

            fetch(`https://bsky.social/xrpc/app.bsky.feed.getAuthorFeed?actor=${profileDid}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {

                // Set profile link
                galleryProfileLink.href = profileUrl;

                // Append images
                data.feed.forEach(item => {
                    if (item.post.embed && item.post.embed.images) {
                        item.post.embed.images.forEach(image => {
                            const imgElement = document.createElement('img');
                            imgElement.src = image.fullsize; // Use image.fullsize for full-size images
                            imgElement.alt = image.alt || 'User media';
                            imgElement.addEventListener('click', function () {
                                currentGalleryImageIndex = Array.from(galleryContainer.querySelectorAll('img')).indexOf(imgElement);
                                showGalleryImageInModal(imgElement.src);
                            });
                            galleryContainer.appendChild(imgElement);
                        });
                    }
                });
            })

            // catch expired token
            .catch(error => {  
                if(error.message.includes('Expired')) {
                    alert('Token expired.');
                } else {
                    console.error('Error fetching gallery images:', error);
                }
            })
            .finally(() => {
                console.log('Gallery images loaded.');
            });
        }

        // Update debug info
        function updateDebugInfo() {
            const debugInfo = document.getElementById('debug-info');
            debugInfo.textContent = `${totalImages} images loaded`;
        }

        // Close modals with ESC key
        document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') {
                if (modal.style.display === 'flex') {
                    modal.style.display = 'none';
                }
                if (galleryModal.style.display === 'flex') {
                    galleryModal.style.display = 'none';
                }
            }
        });

        // Close modals by clicking outside
        window.addEventListener('click', function (event) {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
            if (event.target === galleryModal) {
                galleryModal.style.display = 'none';
            }
        });

        // Show gallery image in modal
        function showGalleryImageInModal(imageUrl) {
            const galleryModalImage = document.getElementById('gallery-modal-image');
            const galleryImageModal = document.getElementById('gallery-image-modal');
            const galleryModal = document.getElementById('gallery-modal');

            // Remove any existing "View Full Size" button to prevent duplicates
            const existingButton = document.querySelector('.view-gallery-full-size-button');
            if (existingButton) {
                existingButton.remove();
            }

            // Set the image source
            galleryModalImage.src = imageUrl;

            // Wait for the image to load to access its natural dimensions
            galleryModalImage.onload = () => {
                const nativeWidth = galleryModalImage.naturalWidth;
                const nativeHeight = galleryModalImage.naturalHeight;
                const displayedWidth = galleryModalImage.clientWidth;
                const displayedHeight = galleryModalImage.clientHeight;

                // Check if the displayed size is smaller than the natural size
                if (displayedWidth < nativeWidth || displayedHeight < nativeHeight) {
                    
                    // Create and display the "View Full Size" button
                    const fullSizeButton = document.createElement('button');
                    fullSizeButton.textContent = 'View Full Size';
                    fullSizeButton.className = 'view-gallery-full-size-button';
                    fullSizeButton.style.position = 'absolute';
                    fullSizeButton.style.bottom = '20px';
                    fullSizeButton.style.right = '20px';
                    fullSizeButton.style.zIndex = '1000';
                    fullSizeButton.style.padding = '10px 20px';

                    fullSizeButton.addEventListener('click', () => {
                        window.open(imageUrl, '_blank'); // Open full-size image in a new tab
                    });

                    // Append the button to the modal
                    galleryImageModal.appendChild(fullSizeButton);

                    // Dynamically enable the magnifier since the button is now present
                    enableMagnifier(galleryModalImage);
                } else {
                    console.log('Image is displayed at full size');
                }
            };

            // Show the modal
            galleryImageModal.style.display = 'flex';
            galleryModal.style.display = 'none'; // Hide the gallery modal
        }

        function navigateGalleryImage(direction) {

            // Dynamically select all gallery images
            const galleryImagesArray = Array.from(document.querySelectorAll('#gallery-modal .grid img'));
            
            if (galleryImagesArray.length === 0) {
                console.error('No gallery images available.');
                return;
            }

            // Update the current index with wrapping logic
            currentGalleryImageIndex = (currentGalleryImageIndex + direction + galleryImagesArray.length) % galleryImagesArray.length;

            // Show the selected image in the gallery modal
            const selectedImage = galleryImagesArray[currentGalleryImageIndex];
            if (selectedImage) {
                showGalleryImageInModal(selectedImage.src);
            } else {
                console.error('Selected image not found.');
            }
        }

        function closeGalleryImageModal() {
            galleryImageModal.style.display = 'none';
            galleryModal.style.display = 'flex'; // Show gallery modal again
        }

        // Close gallery image modal with click outside
        window.addEventListener('click', function (event) {
            if (event.target === galleryImageModal) {
                closeGalleryImageModal();
            }
        });

        document.addEventListener('keydown', function (event) {

            // view full size image
            if(event.key === 'f' || event.key === ' ') {
                if (galleryImageModal.style.display === 'flex') {
                    const fullSizeButton = document.querySelector('.view-gallery-full-size-button');
                    if (fullSizeButton) {
                        fullSizeButton.click();
                    }
                }
            }

            // Navigate gallery images with arrow keys or WASD
            if (galleryImageModal.style.display === 'flex') {
                if (event.key === 'ArrowRight' || event.key.toLowerCase() === 'd') {
                    navigateGalleryImage(1);
                } else if (event.key === 'ArrowLeft' || event.key.toLowerCase() === 'a') {
                    navigateGalleryImage(-1);
                } else if (event.key === 'Escape') {
                    closeGalleryImageModal();
                }
            }

            // Check if the Enter/Return or Space bar is pressed
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault(); // Prevent default action like scrolling

                // Check if the gallery modal is already open
                if (galleryModal.style.display !== 'flex') {
                    // Launch the gallery if there's a token
                    if (token !== null) {
                        viewAllMediaButton.click(); // Simulate click to open gallery
                    }
                } else {
                    // Launch the gallery-image-viewer if the gallery is open
                    const selectedImage = galleryContainer.querySelector('img');
                    if (selectedImage) {
                        selectedImage.click(); // Simulate click to open image viewer
                    }
                }
            }

        });

        // Set default for image sizes
        imageSizeSlider.value = imageSize;
        sliderValueDisplay.textContent = imageSize;

        // Scale images with slider values
        imageSizeSlider.addEventListener('input', function () {
            const newSize = `${this.value}px`;
            sliderValueDisplay.textContent = this.value; // Update displayed value
            const imageContainers = document.querySelectorAll('.image-container'); // Select containers on each input
            imageContainers.forEach(container => {
                container.style.height = newSize;
                const img = container.querySelector('img');
                if (img) {
                    img.style.height = newSize;
                }
            });

            // Update grid-template-columns to allow wrapping
            const imagesContainer = document.getElementById('images-container');
            imagesContainer.style.gridAutoRows = newSize; // Set the height
            imagesContainer.style.gridTemplateColumns = `repeat(auto-fill, minmax(${newSize}, 1fr))`;
        });

        function enableMagnifier(imageElement) {
            const magnifier = document.getElementById('magnifier');

            // Check if the "View Full Size" button is present and visible
            const fullSizeButton = document.querySelector('.view-gallery-full-size-button');
            if (magnifier && (!fullSizeButton || fullSizeButton.style.display === 'none')) {
                magnifier.style.display = 'none'; // Ensure magnifier is hidden
                return; // Exit if the button is not shown
            }

            // Remove previous event listeners to avoid duplication
            imageElement.onmouseenter = null;
            imageElement.onmouseleave = null;
            imageElement.onmousemove = null;

            // Show the magnifier when the mouse enters the image only if it is scaled
            imageElement.onmouseenter = () => {
                const isScaledDown =
                    imageElement.clientWidth < imageElement.naturalWidth ||
                    imageElement.clientHeight < imageElement.naturalHeight;

                if (isScaledDown) {
                    magnifier.style.display = 'block';
                    const nativeWidth = imageElement.naturalWidth;
                    const nativeHeight = imageElement.naturalHeight;

                    magnifier.style.backgroundImage = `url('${imageElement.src}')`;
                    magnifier.style.backgroundSize = `${nativeWidth}px ${nativeHeight}px`;
                } else {
                    magnifier.style.display = 'none'; // Ensure magnifier remains hidden
                }
            };

            // Hide the magnifier when the mouse leaves the image
            imageElement.onmouseleave = () => {
                magnifier.style.display = 'none';
            };

            // Update magnifier position and background on mouse move only if scaled
            imageElement.onmousemove = (event) => {
                const isScaledDown =
                    imageElement.clientWidth < imageElement.naturalWidth ||
                    imageElement.clientHeight < imageElement.naturalHeight;

                if (!isScaledDown) {
                    magnifier.style.display = 'none';
                    return; // Exit if the image is not scaled down
                }

                const rect = imageElement.getBoundingClientRect();
                const mouseX = event.clientX - rect.left;
                const mouseY = event.clientY - rect.top;

                const scaleX = imageElement.naturalWidth / imageElement.clientWidth;
                const scaleY = imageElement.naturalHeight / imageElement.clientHeight;

                const nativeX = mouseX * scaleX;
                const nativeY = mouseY * scaleY;

                magnifier.style.backgroundPosition = `-${nativeX - 256}px -${nativeY - 256}px`;
                magnifier.style.left = `${event.clientX - 256}px`;
                magnifier.style.top = `${event.clientY - 256}px`;
            };
        }

        // Call the function on your modal image
        const galleryModalImage = document.getElementById('gallery-modal-image');
        galleryModalImage.addEventListener('load', () => {
            enableMagnifier(galleryModalImage);
        });


        // Login to Bluesky
        // Define the service URL (update this if required)
        const serviceUrl = 'https://bsky.social';

        // Function to create a new session token
        async function createSession() {
            try {
                // Make a POST request to the server
                const response = await fetch(`${serviceUrl}/xrpc/com.atproto.server.createSession`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        identifier: bsky_identifier,
                        password: bsky_appPassword,
                    }),
                });

                // Check if the response is successful
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Authentication failed: ${errorText}`);
                }

                // Parse and return the response as JSON
                const tokens = await response.json();
                console.log('Authentication successful. Tokens:', tokens);
                return tokens;
            } catch (error) {
                console.error('Error during session creation:', error.message);
            }
        }

        // Function to handle token creation and renewal
        async function handleAuthentication() {
            if (bsky_identifier && bsky_appPassword) {
                console.log('Starting authentication...');

                // Attempt to create a session
                const tokens = await createSession();

                if (tokens) {
                    // Store tokens for use
                    token = tokens.accessJwt;
                    refreshToken = tokens.refreshJwt;

                    // Show the view all media button
                    viewAllMediaButton.style.display = 'block';

                    console.log('Session token:', tokens.accessJwt);

                    // Schedule token renewal before expiration
                    scheduleTokenRenewal(tokens);
                } else {
                    console.error('Failed to obtain tokens.');
                }
            } else {
                console.warn('No credentials provided. Authentication skipped.');
            }
        }

        // Function to schedule token renewal
        function scheduleTokenRenewal(tokens) {
            if (!tokens.expiresIn) {
                console.warn('Token expiration information not available. Renewal skipped.');
                return;
            }

            // Calculate when to renew the token (e.g., 90% of its lifespan)
            const renewalTime = tokens.expiresIn * 0.9 * 1000; // Convert seconds to milliseconds
            console.log(`Token renewal scheduled in ${renewalTime / 1000} seconds.`);

            setTimeout(async () => {
                console.log('Renewing token...');
                await handleAuthentication(); // Re-authenticate to refresh tokens
            }, renewalTime);
        }

        // Start the authentication process
        handleAuthentication();

    });
        
    </script>
    
</body>
</html>
